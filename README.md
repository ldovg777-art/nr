# Проект Node-RED: кристаллизация

## Проект "Часы и календарь"

Добавлен поток [`flows_dashboard_clock_calendar.json`](./flows_dashboard_clock_calendar.json), который выводит на дашборд Node-RED актуальное время и интерактивный календарь:

- секундный таймер обновляет данные без перезагрузки страницы;
- цифровые часы показывают текущее время в формате `ЧЧ:ММ:СС`;
- текстовый блок выводит полную дату с днём недели на русском языке;
- кастомный календарь подсвечивает текущий день и построен в понедельничном формате недели.

### Как импортировать поток "Часы и календарь"

1. Откройте панель управления Node-RED (обычно `http://<адрес>:1880`).
2. Нажмите меню **☰** → **Import** → **Clipboard**.
3. Скопируйте содержимое файла [`flows_dashboard_clock_calendar.json`](./flows_dashboard_clock_calendar.json) и вставьте в окно импорта.
4. Включите опцию **Import to new flow**, затем нажмите **Import**.
5. На вкладке появится поток «Часы и календарь». При необходимости измените название вкладки или группы.
6. Нажмите **Deploy**, чтобы сохранить и отобразить часы и календарь на дашборде.

### Советы по настройке дашборда

- Чтобы изменить размер виджетов, откройте вкладку **Dashboard** в правой панели и скорректируйте ширину группы «Дата и время».
- Цвет подсветки текущей даты можно изменить в узле `ui_template`, поправив правило `.calendar-day.today` в секции `<style>`.
- Для отображения календаря на отдельной странице дашборда создайте новый `ui_tab` и перенесите группу в него.

## Проект "Кристаллизация"
В функции `Обработка COOLING` добавлены проверки и защита данных, чтобы алгоритм охлаждения работал стабильно:

- Температура и конфигурационные параметры теперь приводятся к конечным числам и проверяются на положительность перед расчётами.
- Скользящее окно измерений перестраивается заново при первом валидном значении, чтобы исключить артефакты от старых данных.
- Фиксация максимального тангенса и обратный отсчёт выполняются только после минимальной выдержки времени охлаждения; счётчик не допускается к отрицательным значениям.
- Переход в состояние `CALCULATING` возможен лишь при наличии подтверждённого максимума или при достижении нижнего температурного порога.

Эти изменения защищают от некорректных измерений, устраняют скачки в графиках и гарантируют корректное завершение цикла охлаждения.

## Как получить проект с этими изменениями
1. Откройте панель управления Node-RED (обычно `http://<адрес>:1880`).
2. В правом верхнем углу нажмите меню **☰** и выберите пункт **Import** → **Clipboard**.
3. Скопируйте содержимое файла [`flows_crystallization_ver_2025-10-07_01.json`](./flows_crystallization_ver_2025-10-07_01.json) и вставьте его в поле импорта.
4. Убедитесь, что опция **Import to new flow** включена, затем нажмите **Import**.
5. На рабочем поле появится новый поток. Если нужно, переименуйте вкладку и упорядочьте узлы.
6. Нажмите кнопку **Deploy** в правом верхнем углу, чтобы сохранить и запустить поток с обновлённой логикой охлаждения.

После деплоя функция `Обработка COOLING` начнёт работать с описанными улучшениями без дополнительной настройки.

## Как правильно скопировать содержимое JSON-файла

1. Откройте файл [`flows_crystallization_ver_2025-10-07_01.json`](./flows_crystallization_ver_2025-10-07_01.json) в браузере или редакторе кода.
2. Если пользуетесь веб-интерфейсом Git, нажмите кнопку **Raw** (или аналогичную), чтобы отобразить чистый JSON без форматирования страницы.
3. Выделите весь текст (`Ctrl+A` или `⌘+A`), затем скопируйте его (`Ctrl+C`/`⌘+C`).
4. В окне импорта Node-RED вставьте содержимое сочетанием `Ctrl+V`/`⌘+V` и нажмите **Import**.
5. При необходимости сохраните файл локально: создайте новый `.json`-файл, вставьте в него скопированный текст и сохраните.

## Как скачать файл с потоком целиком

Если удобнее получить изменения в виде готового файла, воспользуйтесь одним из способов:

### Через веб-интерфейс Git (GitHub, GitLab и т.п.)

1. Откройте файл `flows_crystallization_ver_2025-10-07_01.json` в репозитории.
2. Нажмите кнопку **Download raw file** / **Скачать** / **Raw** (название зависит от хостинга).
3. Браузер предложит сохранить файл. Укажите папку и подтвердите загрузку — получится готовый JSON, который можно импортировать в Node-RED.

### Из локального репозитория

1. Склонируйте или обновите репозиторий командой `git clone` / `git pull`.
2. Перейдите в каталог проекта и скопируйте файл `flows_crystallization_ver_2025-10-07_01.json` (например, через проводник или команду `cp`).
3. Полученный файл можно перенести на машину с Node-RED и импортировать через меню **Import** → **File**.

### Экспорт из запущенного Node-RED

1. Если поток уже развёрнут, откройте меню **☰** → **Export**.
2. Выберите вкладку с нужным потоком и поставьте галочку **Selected nodes** или **Current flow**.
3. Нажмите **Download** — Node-RED сохранит актуальный JSON-файл на ваш компьютер.

## Зачем нужны версии в имени файла потока

Суффикс `ver_2025-10-07_01` в названии файла показывает дату сборки и номер ревизии:

- **Дата** (`2025-10-07`) помогает быстро определить, когда был сформирован поток и какие обновления в него вошли.
- **Номер версии** (`01`, `02`, …) позволяет выпускать несколько итераций за один день, не затирая предыдущие.
- Версионирование облегчает сравнение изменений и откат к стабильной конфигурации.

При каждом значимом обновлении увеличивайте номер версии или дату, чтобы история изменений оставалась прозрачной.
